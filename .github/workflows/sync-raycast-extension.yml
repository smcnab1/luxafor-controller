name: Sync raycast-extension to main

on:
  push:
    branches:
      - raycast-extension
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # fetch full history so we can switch branches

      - name: Set up Git
        run: |
          git config user.name "smcnab1"
          git config user.email "108990188+smcnab1@users.noreply.github.com"

      - name: Fetch target and source branches
        run: |
          # Ensure both branches exist locally
          git fetch origin main:main
          git fetch origin raycast-extension:raycast-extension
          git branch --all

      - name: Switch to main
        run: git checkout main

      - name: Copy files from raycast-extension
        run: |
          git restore --source=raycast-extension -- \            assets/* \
            media/* \
            metadata/* \
            .gitignore \
            .prettierrc \
            CHANGELOG.md \
            LICENSE \
            SETUP.md \
            eslint.config.js \
            package-lock.json \
            package.json \
            raycast-env.d.ts \
            tsconfig.json \
            src/*

      - name: Commit & push if there are changes
        run: |
          if ! git diff --quiet; then
            git add -A
            git commit -m "chore(sync): update selected files from raycast-extension"
            git push origin main
          else
            echo "No changes to commit."
          fi